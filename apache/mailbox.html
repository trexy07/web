<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Carter's Mailbox Files</title>
    <style>
        body { font-family: 
            Arial, sans-serif; 
            margin: 2em;  
            background: linear-gradient(to bottom right, #1f0de0, #0d0663);
            min-height: 100vh; 
            min-width : 100vh; 
            color: #fff;
            /* font-size: 1.5em; */

            
        }
        ul { list-style-type: none; padding: 0; background: transparent; }
        li { padding: 0.5em 0; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; 
            /* font-size: 1.5em; */
        }
        .download-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 2.2em;
            padding: 0 1em;
            border-radius: 0.5em;
            background: #007bff;
            color: #fff;
            border: none;
            text-decoration: none;
            margin-right: 0.5em;
            font-size: 1.1em;
            transition: background 0.2s;
        }
        .download-btn:hover {
            background: #0056b3;
            color: #fff;
            text-decoration: none;
        }
        .upload-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 2.2em;
            padding: 0 1em;
            border-radius: 0.5em;
            background: green;
            color: #fff;
            border: none;
            text-decoration: none;
            margin-right: 0.5em;
            font-size: 1.1em;
            transition: background 0.2s;
        }
        .upload-btn:hover {
            background: #006600 ;
            color: #fff;
            text-decoration: none;
            /* font-size: 1.1em; */
        }
        
        /* Add CSS for delete button */
        .delete-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 2.2em;
            padding: 0 0.8em;
            border-radius: 0.5em;
            background: #dc3545;
            color: #fff;
            border: none;
            font-size: 1.1em;
            margin-left: 0.1em;
            cursor: pointer;
            transition: background 0.2s;
        }
        .delete-btn:hover {
            background: #b52a37;
        }
    </style>
</head>
<body>
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1em;">
        <h1 style="margin: 0;">Carter's Mailbox Files</h1>
        <div>
            <button id="backBtn" class="upload-btn" style="margin-right:0.5em;">Back</button>
            <button id="uploadBtn" class="upload-btn">Upload File</button>
        </div>
    </div>
    <ul id="file-list">
        <li>Loading files...</li>
    </ul>
    <input type="file" id="fileInput" style="display:none">
    <script>
        function getFolderFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('folder') || '';
        }
        function setFolderInUrl(folder, push = false) {
            const params = new URLSearchParams(window.location.search);
            if (folder) {
                params.set('folder', folder);
            } else {
                params.delete('folder');
            }
            const newUrl = '?' + params.toString();
            if (push) {
                history.pushState({ folder }, '', newUrl);
            } else {
                history.replaceState({ folder }, '', newUrl);
            }
        }
        function getParentFolder(folder) {
            if (!folder) return '';
            const parts = folder.split('/');
            parts.pop();
            return parts.join('/');
        }
        function list(subdir = '', pushHistory = false) {
            setFolderInUrl(subdir, pushHistory);
            updateBackBtn();
            const apiPath = subdir ? `/api/mailbox/${encodeURIComponent(subdir)}` : '/api/mailbox';
            fetch(apiPath)
                .then(response => response.json())
                .then(files => {
                    const fileList = document.getElementById('file-list');
                    fileList.innerHTML = '';
                    files.forEach(file => {
                        const li = document.createElement('li');
                        li.textContent = file.filename;

                        // Create a container for the buttons
                        const btnGroup = document.createElement('span');
                        btnGroup.style.display = 'flex';
                        btnGroup.style.alignItems = 'center';

                        if (file.isFolder) {
                            // Folder: Open button
                            const openBtn = document.createElement('button');
                            openBtn.textContent = 'Open';
                            openBtn.className = 'download-btn';
                            openBtn.onclick = function() {
                                list((subdir ? subdir + '/' : '') + file.filename, true);
                            };
                            btnGroup.appendChild(openBtn);
                        } else {
                            // File: Download button
                            const downloadBtn = document.createElement('a');
                            downloadBtn.textContent = 'Download';
                            downloadBtn.className = 'download-btn';
                            downloadBtn.href = file.path;
                            downloadBtn.download = '';
                            btnGroup.appendChild(downloadBtn);
                        }

                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = 'ðŸ—‘ï¸';
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.title = 'Delete';
                        deleteBtn.onclick = function() {
                            if (confirm('Delete ' + file.filename + '?')) {
                                // Send folder param if not root
                                const folder = getFolderFromUrl();
                                let deleteUrl = '/api/delete/' + encodeURIComponent(file.filename);
                                if (folder) {
                                    deleteUrl += '?folder=' + encodeURIComponent(folder);
                                }
                                fetch(deleteUrl, {
                                    method: 'GET',
                                })
                                .then(() => list(folder))
                            }
                        };

                    btnGroup.appendChild(deleteBtn);
                    li.textContent = '';
                    li.appendChild(document.createTextNode(file.filename));
                    li.appendChild(btnGroup);
                    fileList.appendChild(li);
                });
            })
            .catch(() => {
                document.getElementById('file-list').innerHTML = '<li>Failed to load files.</li>';
        });
    }
    // Handle browser navigation (back/forward)
    window.onpopstate = function() {
        list(getFolderFromUrl());
    };
    // On page load, use folder from URL
    list(getFolderFromUrl());
    document.getElementById('uploadBtn').onclick = function() {
        document.getElementById('fileInput').click();
    };
    document.getElementById('fileInput').onchange = function() {
        if (this.files.length > 0) upload();
    };
    function upload() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        // Add folder query param if not root
        const folder = getFolderFromUrl();
        let uploadUrl = 'api/upload';
        if (folder) {
            uploadUrl += '?folder=' + encodeURIComponent(folder);
        }
        fetch(uploadUrl, {
            method: 'POST',
            body: formData,
        })
        .then(() => list(getFolderFromUrl()))
    }
    function updateBackBtn() {
        const current = getFolderFromUrl();
        document.getElementById('backBtn').disabled = !current;
    }
    document.getElementById('backBtn').onclick = function() {
        const current = getFolderFromUrl();
        const parent = getParentFolder(current);
        list(parent, true);
    };
    </script>
</body>
</html>